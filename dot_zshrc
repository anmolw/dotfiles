# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Function for detecting if an executable is in path
# Taken from https://stackoverflow.com/a/53798785

function is_bin_in_path {
  builtin whence -p "$1" &> /dev/null
}

# Set PATH

PATH="${HOME}/.local/bin:${PATH}"

# Download Znap, if it's not there yet.
[[ -r ~/repos/znap/znap.zsh ]] ||
  git clone --depth 1 -- \
      https://github.com/marlonrichert/zsh-snap.git ~/repos/znap
source ~/repos/znap/znap.zsh  # Start Znap

# znap prompt sindresorhus/pure

# `znap source` starts plugins.
znap source marlonrichert/zsh-autocomplete
znap source romkatv/powerlevel10k
znap source zsh-users/zsh-syntax-highlighting

# zsh-autocomplete settings

# https://github.com/marlonrichert/zsh-autocomplete?tab=readme-ov-file#make-tab-and-shifttab-cycle-completions-on-the-command-line
bindkey '^I' menu-complete
# https://github.com/marlonrichert/zsh-autocomplete?tab=readme-ov-file#insert-prefix-instead-of-substring
bindkey "$terminfo[kcbt]" reverse-menu-complete
zstyle ':completion:*:*' matcher-list 'm:{[:lower:]-}={[:upper:]_}' '+r:|[.]=**'

# `znap install` adds new commands and completions.
znap install zsh-users/zsh-completions
znap install nix-community/nix-zsh-completions

#If homebrew is installed, initialize it and load its completions

if [[ -r /home/linuxbrew/.linuxbrew/bin/brew ]]
then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

if type brew &>/dev/null
then
  FPATH="$(brew --prefix)/share/zsh/site-functions:${FPATH}"
fi

# Nix
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
  . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
  fpath=(${HOME}/.nix-profile/share/zsh/site-functions $fpath)
fi
# End Nix

# Add pixi to path and enable autocompletion if it's installed

if [[ -r "${HOME}/.pixi/" ]]
then
  PATH="${HOME}/.pixi/bin:${PATH}"
  eval "$(pixi completion --shell zsh)"
fi

# Add cargo's bin directory to path if it's installed

if [[ -r "${HOME}/.cargo/bin" ]]
then
  PATH="${HOME}/.cargo/bin:${PATH}"
  . "$HOME/.cargo/env"
fi

# zoxide integation
if is_bin_in_path zoxide; then
  eval "$(zoxide init zsh)"
fi

# Run WSL2 SSH Agent bridge

if [[ -n $WSL_DISTRO_NAME ]]
then
  eval "$(~/.local/bin/wsl2-ssh-agent)"
# If we're running on linux, but not in WSL or an SSH session with forwarding enabled, use keychain to manage ssh keys
# elif [[ -z $SSH_AUTH_SOCK && $OSTYPE == "linux-gnu" ]]
# then
#     eval "$(keychain -q -Q --eval id_github)"
else
	export SSH_AUTH_SOCK=$XDG_RUNTIME_DIR/ssh-agent.socket
fi

if is_bin_in_path direnv; then
	eval "$(direnv hook zsh)"
fi

if is_bin_in_path atuin; then
	eval "$(atuin init zsh)"
fi

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh
